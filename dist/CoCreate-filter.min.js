!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.filter=e():(t.CoCreate=t.CoCreate||{},t.CoCreate.filter=e())}(this,function(){return n={},i.m=r=[function(e,t){function r(t){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=r=function(t){return typeof t}:e.exports=r=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}e.exports=r},function(t,e,r){"use strict";r.r(e);var n=r(0),i=r.n(n),n={items:[],ioInstance:null,moduleAttribues:[],module_items:[],__init:function(){this.__initIntesection(),this.__initSocket(),this.__initEvents()},__initIntesection:function(){var r=this;this.ioInstance=new IntersectionObserver(function(t,e){t.forEach(function(t){var e;t.isIntersecting&&((e=r.__getMainAttribue(t.target)).id&&document.dispatchEvent(new CustomEvent("CoCreateFilter-loadMore",{detail:{attrName:e.name,attrId:e.id}})),r.ioInstance.unobserve(t.target))})},{threshold:1})},__runLoadMore:function(e,r){var t;r&&e&&((t=this.items.find(function(t){return t.attrName===e&&t.id===r}))&&0<t.count&&this.fetchData(t))},__getMainAttribue:function(e){var t=this.moduleAttribues.find(function(t){return""!==(e.getAttribute(t)||"")});return t?{name:t,id:e.getAttribute(t)}:{}},__initSocket:function(){var a=this;CoCreate.crud.listenMessage("readDocumentList",function(t){var e,r,n,i=t.element,o=a.items.find(function(t){return t.id===i});o&&(e=t.data,r=document.querySelector("[".concat(o.attrName,'="').concat(o.id,'"][data-fetch_type="scroll"]')),0<e.length&&r&&a.ioInstance.observe(r),n=t.operator.total,(o=document.querySelectorAll("[".concat(o.attrName,'="').concat(o.id,'"][data-fetch_type="total"]')))&&o.forEach(function(t){return t.innerHTML=n}))})},__initEvents:function(){var r=this;document.addEventListener("CoCreateFilter-loadMore",function(t){var e=t.detail.attrId,t=t.detail.attrName;r.__runLoadMore(t,e)}),document.querySelectorAll('[data-fetch_type="loadmore"]').forEach(function(e){e.addEventListener("click",function(t){t.preventDefault();t=r.__getMainAttribue(e);t.id&&r.__runLoadMore(t.attrName,t.attrId)})})},setFilter:function(t,e,r){if(e){var n=t.getAttribute(e);if(n){this.moduleAttribues.includes(e)||this.moduleAttribues.push(e);var i=t.getAttribute("data-fetch_collection"),o="collection"==t.getAttribute("data-fetch_value_type"),a=t.getAttribute("data-order_by"),c=t.getAttribute("data-order_type")||"asc",l=parseInt(t.getAttribute("data-fetch_count")),o={el:t,id:n,eId:n,type:r,attrName:e,collection:i,startIndex:0,options:{},fetch:{},is_collection:o,search:{type:"or",value:[]},orders:[],filters:[]};return!isNaN(l)&&0<l&&(o.count=l),a&&o.orders.push({name:a,type:"asc"==c?1:-1}),this._initFilter(o,n,e),this._initOrder(o,n,e),this.items.push(o),this._initInputForm(o,e),this._initExportImport(o,n,e),o}}},_initFilter:function(t,e,r){for(var n=t.el.getRootNode().querySelectorAll("["+r+'="'+e+'"]'),i=0;i<n.length;i++){var o=n[i],a=o.getAttribute("data-filter_name"),c=o.getAttribute("data-filter_operator")?o.getAttribute("data-filter_operator"):"$contain",l=o.getAttribute("data-filter_value_type")?o.getAttribute("data-filter_value_type"):"string",u=o.getAttribute("data-filter_type"),s=o.getAttribute("data-filter_value");if(null!=s)if("raw"!==l&&(s=s.replace(/\s/g,"").split(",")),a){o=this.getFilterByName(t,a,c);if("string"!=l)for(var d=0;d<s.length;d++)s[d]=Number(s[d]);this.insertArrayObject(t.filters,o,{name:a,value:s,operator:c,type:u})}else t.search.value=this._makeSearchOption(e,r)}},_initOrder:function(r,t,e){for(var n=r.el.getRootNode().querySelectorAll("["+e+'="'+t+'"]'),i=this,o=0;o<n.length;o++){var a=n[o],c=a.getAttribute("data-order_by"),l=a.getAttribute("value");c&&l&&(["A","BUTTON"].includes(a.tagName)?a.addEventListener("click",function(){var t=this.getAttribute("data-order_by"),e=this.getAttribute("value");i._applyOrder(r,t,e),r.el&&r.el.dispatchEvent(new CustomEvent("changeFilterInput",{detail:{type:"order"}}))}):this._applyOrder(r,c,l))}this._initToggleOrderEvent(r,t,e)},_initToggleOrderEvent:function(i,t,e){var o=document.querySelectorAll("[".concat(e,'="').concat(t,'"][data-toggle_order]')),a=this;o.forEach(function(n){n.addEventListener("click",function(){for(var t=this.getAttribute("data-toggle_order")||"",e=this.getAttribute("data-order_by"),t="asc"===t?"desc":"asc",r=0;r<o.length;r++)o[r]!==n&&o[r].setAttribute("data-toggle_order","");i.orders=[],a._applyOrder(i,e,t),n.setAttribute("data-toggle_order",t),i.el&&i.el.dispatchEvent(new CustomEvent("changeFilterInput",{detail:{type:"order"}}))})})},_initExportImport:function(r,t,e){var n=document.querySelector("[data-export_type][".concat(e,'="').concat(t,'"]')),t=document.querySelector('[data-import="true"]['.concat(e,'="').concat(t,'"]')),i=this;n&&n.addEventListener("click",function(){var t;r&&((t=i.makeFetchOptions(r)).export={collection:t.collection,type:n.getAttribute("data-export_type")||"json"},CoCreate.crud.readDocumentList(t))}),t&&t.addEventListener("click",function(){var e,t=document.createElement("input");t.type="file",r&&(e=r.collection,t.onchange=function(t){t=t.target.files[0];CoCreate.crud.importCollection({collection:e,file:t})},t.click())})},_applyOrder:function(t,e,r){var n,i;r&&(i=0,n=this.getOrderByName(t,e),i="asc"==r?1:"desc"==r?-1:[],this.insertArrayObject(t.orders,n,{name:e,type:i},i))},changeCollection:function(t){var e=t.el.getAttribute("data-fetch_collection");t.collection=e,t.startIndex=0},_makeSearchOption:function(t,e){for(var r=document.querySelectorAll("form["+e+"="+t+"]"),t="["+e+"="+t+"]",t=document.querySelectorAll("input"+t+",textarea"+t+", select"+t),n=[],i=0;i<r.length;i++)var o=r[i].querySelectorAll("input, textarea, select"),o=Array.prototype.slice.call(o),n=n.concat(o);t=Array.prototype.slice.call(t),n=n.concat(t);for(var a=[],c=0;c<n.length;c++){var l=n[c].getAttribute("data-filter_name"),u=n[c].getAttribute("data-order_by"),s=n[c],d=s.getAttribute("data-value_type")?s.getAttribute("data-value_type"):"string",f=null;l||u||("checkbox"!=s.type||s.checked?(f=s.value,(f="string"!=d?Number(f):f)&&!a.includes(f)&&a.push(f)):f=null)}return a},_initInputForm:function(t,e){if(t){var r="["+e+'="'+t.id+'"]',n=t.el.getRootNode().querySelectorAll("form"+r+" input, form"+r+" textarea, form"+r+" select"),r=t.el.getRootNode().querySelectorAll("input"+r+",textarea"+r+", select"+r);this.setCheckboxName(t.id,e),n=Array.prototype.slice.call(n),r=Array.prototype.slice.call(r),n=n.concat(r);for(var i=0;i<n.length;i++){var o=n[i];o.getAttribute("data-order_by")?this._initOrderInput(t,o):this._initFilterInput(t,o,t.id)}}},_initOrderInput:function(n,t){var i=this;t.addEventListener("change",function(t){t.preventDefault();var e=this.getAttribute("data-order_by"),r=0,t=i.getOrderByName(n,e),r="asc"==this.value?1:"desc"==this.value?-1:[];i.insertArrayObject(n.orders,t,{name:e,type:r},r),n.el&&n.el.dispatchEvent(new CustomEvent("changeFilterInput",{detail:{type:"order"}}))})},_initFilterInput:function(u,s,d){var e,f=this;s.addEventListener("input",function(t){t.preventDefault();var o=this.getAttribute("data-filter_name"),a=this.getAttribute("data-filter_operator")||"$contain",c=this.getAttribute("data-filter_type"),l=this.getAttribute("data-filter_value_type")||"string";clearTimeout(e),e=setTimeout(function(){if(o){var t=f.getFilterByName(u,o,a),e=s.type,r=[];if("checkbox"==e)for(var n=document.querySelectorAll("input[name="+s.name+"]:checked"),i=0;i<n.length;i++)r.push(n[i].value);else"raido"==e||("range"==e?r=[Number(s.min),Number(s.value)]:(e=s.value,"none"!=(e="string"!=l?Number(e):e)&&(r=[e]),"raw"===l&&(r=e)));f.insertArrayObject(u.filters,t,{name:o,value:r,operator:a,type:c})}else u.search.value=f._makeSearchOption(d,u.attrName);u.el&&u.el.dispatchEvent(new CustomEvent("changeFilterInput",{detail:{type:"filter"}}))},500)})},setCheckboxName:function(t,e){for(var r=document.querySelectorAll("form["+e+'="'+t+'"]'),n=0;n<r.length;n++)for(var i=r[n].querySelectorAll("input[type=checkbox], form input[type=radio]"),o=0;o<i.length;o++){var a=i[o].getAttribute("name"),c=i[o].getAttribute("data-filter_name");!a&&c&&i[o].setAttribute("name","_"+t+"-"+c+"_"+n)}},getFilterByName:function(t,e,r){for(var n=0;n<t.filters.length;n++){var i=t.filters[n];if(i.name==e&&i.operator==r)return n}return-1},insertArrayObject:function(t,e,r,n){return n=n||r.value,"object"==i()(n)&&0==n.length?-1!=e&&t.splice(e,1):-1!=e?t[e]=r:t.push(r),t},getOrderByName:function(t,e){for(var r=0;r<t.orders.length;r++)if(t.orders[r].name==e)return r;return-1},defineEvent:function(t){t.el.addEventListener("fetchFilterData",function(t){console.log(t)})},fetchData:function(t){t=this.makeFetchOptions(t);CoCreate.crud.readDocumentList(t)},getObjectByFilterId:function(t,e){for(var r=0;r<t.length;r++){var n=t[r].filter;if(n&&n.id==e)return t[r]}},getObjectByElement:function(t,e){for(var r=0;r<t.length;r++){var n=t[r].filter;if(n&&n.el.isSameNode(e))return t[r]}},makeFetchOptions:function(t){var e={collection:t.collection,element:t.eId,metadata:{isRefresh:t.isRefresh},operator:{filters:t.filters,orders:t.orders,search:t.search,startIndex:t.startIndex},is_collection:t.is_collection};return t.count&&(e.operator.count=t.count),e},init:function(t){var e=t.name,r=t.attribute,n=t.callback,t=document.querySelectorAll("[data-fetch_collection][".concat(r,"]")),i=this;t.forEach(function(t){i.__initFilterElement(t,r,e)}),CoCreate.socket.listen("readDocumentList",function(t){n.call(null,t)})},__initFilterElement:function(t,e,r){var n,i=t.getAttribute(e),o=this;!i||(n=this.setFilter(t,e,r))&&(this.module_items.push({el:t,filter:n,id:i,name:r}),t.addEventListener("changeFilterInput",function(t){o.fetchData(n)}),this.fetchData(n))}};n.__init(),e.default=n}],i.c=n,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1).default;function i(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return r[t].call(e.exports,e,e.exports,i),e.l=!0,e.exports}var r,n});